<div class="container">
  <div class="search-form text-center">
    <%= form_with url: search_posts_path, method: :get, local: true do |f| %>
      <%= f.text_field :keyword, placeholder: "投稿を検索する" %>
      <%= f.submit "検索" %>
    <% end %>
  </div>
  <div class="text-right index-new">
    <%= link_to new_post_path do %>
      <button type="button" class="btn btn-primary">＋</button>
    <% end %>
  </div>
    <div class="row row-cols-1 row-cols-md-2 g-4">
      <% @posts.each do |post| %>
      <div class="col">
	      <div class="card w-100 h-100 mx-auto mt-5 shadow-lg">
          <%= link_to post_path(post) do %>
            <%= image_tag post.get_image(100,100), class:"card-img-top"; %>
          <% end %>
          <div class="card body">
            <div class="row">
              <div class="col-5">
                <p class="text-center"><%= image_tag post.end_user.get_profile_image(100,100), class:"mt-3 rounded-circle"; %></p>
              </div>
              <div class="col-6">
                <br>
                <p><%= link_to post.title, post_path(post) %></p>
                <p><%= link_to post.end_user.name, end_users_my_page_path %></p>
                <p><%= link_to "#{post.comments.count} コメント", post_path(post.id) %></p>
                <p><% @tag_list.each do |list|%></p>
                    <%= link_to list.name,search_tag_posts_path(tag_id: list.id) %>
                    <%="(#{list.posts.count})" %>
                  <% end %>
                </p>
                <p>
                  <i class="fa-sharp fa-solid fa-tags"><%= post.tags.map(&:name).join(', ') %></i>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% end %>
      <%= paginate @posts %>
    </div>

    <div id='map'></div>

      <style>
      #map {
        height: 600px;
        width: 100%;
      }
      </style>

      <!-- js部分 -->
      <script>
          function initMap() {

            //初期表示位置
            let latlng = new google.maps.LatLng(38.60, 139.5);
            //デザイン
            let styles = [
                 {
                  stylers: [
                   { "saturation": 0 },
                   { "lightness": 0 }
                  ]
                 }
                ];

            let map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5.5,
                styles: styles,
                center: latlng
            });
            let transitLayer = new google.maps.TransitLayer();
            transitLayer.setMap(map);

      //複数マーカー ここから
            <% @posts.each do |post|%>
              ( function() {
                let markerLatLng = { lat: <%= post.latitude %>, lng: <%= post.longitude %> }; // 緯度経度のデータ作成
                let marker = new google.maps.Marker({
                  position: markerLatLng,
                  map: map
                });
      //マーカーをクリックしたとき、詳細情報を表示
                let infowindow = new google.maps.InfoWindow({
                  position: markerLatLng,
                  content: "<a href='<%= post_url(post.id) %>' target='_blank'><%= post.caption %></a>"
                }); //ここで詳細ページへのリンクを表示させる
                marker.addListener('click', function() {
                  infowindow.open(map, marker);
                });

             })();
            <% end %>
            //複数マーカー ここまで
        }
      </script>

      <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API'] %>&callback=initMap" async defer></script>
</div>
